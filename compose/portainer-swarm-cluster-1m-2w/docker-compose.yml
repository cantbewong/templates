services:
  swarm-manager:
    image: docker:20-dind
    privileged: true
    hostname: swarm-manager
    network_mode: bridge
    ports:
      - "${AGENT_PORT:-9001}:${AGENT_PORT:-9001}"
    healthcheck:
      test: netstat -an | grep ${AGENT_PORT:-9001} > /dev/null; if [ 0 != $$? ]; then exit 1; fi;
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
  swarm-worker-1:
    image: docker:20-dind
    privileged: true
    hostname: swarm-worker-1
    network_mode: bridge
  swarm-worker-2:
    image: docker:20-dind
    privileged: true
    hostname: swarm-worker-2
    network_mode: bridge
  conductor:
    image: deviantony/sind-conductor:latest
    network_mode: bridge
    environment:
      WAIT_HOSTS: swarm-manager:2376, swarm-worker-1:2376, swarm-worker-2:2376
      SWARM_MANAGERS: swarm-manager
      SWARM_WORKERS: swarm-worker-1,swarm-worker-2
      AGENT_PORT: ${AGENT_PORT:-9001}
      AGENT_VERSION: ${AGENT_VERSION:-latest}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock